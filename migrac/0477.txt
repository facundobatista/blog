2010-08-20 16:32:21
Analizando la memoria en Python
<tags>


Estoy haciendo un análisis de la memoria del <a href="http://launchpad.net/ubuntuone-client">cliente de Ubuntu One</a> (particularmente unos módulos que conforman el SyncDaemon propiamente dicho), y me pareció tan copado que muestro acá parte de eso (aprendí el 99% de esto gracias a <a href="http://launchpad.net/~verterok">Guillo</a>).



El análisis se basa en usar <a href="http://guppy-pe.sourceforge.net/">Heapy</a>. Si a ubuntuone-client se lo levanta con <span style="font-family: courier new,courier">--debug-heapy_monitor</span>, el mismo hace (sacando el manejo de error):

<blockquote>
	<span style="font-family: courier new,courier">import guppy.heapy.RM</span>

	<span style="font-family: courier new,courier">guppy.heapy.RM.on()</span>

</blockquote>
Nada más. Entonces, lo ejecuté, y lo llevé a un estado en donde quería probar un par de cosas.



En otra terminal, ejecuté:

<blockquote>
	<span style="font-family: courier new,courier">python -c "from guppy import hpy; hpy().monitor()"

	</span>
</blockquote>
Y eso me abrió una linea de comandos a través de la cual me conecté a mi programa Python que estaba ejecutando en la otra ventana (sí, a SyncDaemon):

<blockquote>
	<span style="font-family: courier new,courier">&lt;Monitor> </span>

	<span style="font-family: courier new,courier">*** Connection 1 opened ***</span>

	<span style="font-family: courier new,courier">&lt;Monitor> lc</span>

	<span style="font-family: courier new,courier">CID PID&nbsp; ARGV</span>

	<span style="font-family: courier new,courier">&nbsp; 1 4451 ['bin/ubuntuone-syncdaemon', '--debug-heapy_monitor']</span>

	<span style="font-family: courier new,courier">&lt;Monitor> sc 1</span>

	<span style="font-family: courier new,courier">Remote connection 1. To return to Monitor, type &lt;Ctrl-C> or .&lt;RETURN></span>

	<span style="font-family: courier new,courier">&lt;Annex> h</span>

	

	<span style="font-family: courier new,courier">Documented commands (type help &lt;topic>):</span>

	<span style="font-family: courier new,courier">========================================</span>

	<span style="font-family: courier new,courier">close&nbsp; h&nbsp; help&nbsp; int&nbsp; isolatest&nbsp; q&nbsp; reset&nbsp; stat</span>

	

	<span style="font-family: courier new,courier">&lt;Annex> stat</span>

	<span style="font-family: courier new,courier">Target overview</span>

	<span style="font-family: courier new,courier">------------------------------------</span>

	<span style="font-family: courier new,courier">target.sys.executable&nbsp;&nbsp; = /usr/bin/python</span>

	<span style="font-family: courier new,courier">target.sys.argv&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = ['bin/ubuntuone-syncdaemon', '--debug-heapy_monitor']</span>

	<span style="font-family: courier new,courier">target.wd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = /home/facundo/canonical/u1-client/aq-memory-improvements</span>

	<span style="font-family: courier new,courier">target.pid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 4451</span>

	<span style="font-family: courier new,courier">------------------------------------</span>

</blockquote>
Abrí una consola interactiva, y le dije que me tomara un snapshot del <span style="font-family: courier new,courier">heap</span>:

<blockquote>
	<span style="font-family: courier new,courier">&lt;Annex> int</span>

	<span style="font-family: courier new,courier">Remote interactive console. To return to Annex, type '-'.</span>

	<span style="font-family: courier new,courier">>>> h1 = hp.heap()</span>

</blockquote>
Luego hice tiré un archivo con contenido a Ubuntu One, volví a pedir el <span style="font-family: courier new,courier">heap</span>. Y miré las diferencias:

<blockquote>
	<span style="font-family: courier new,courier">>>> h2 = hp.heap()</span>

	<span style="font-family: courier new,courier">>>> h2.diff(h1)</span>

	<span style="font-family: courier new,courier">Summary of difference operation (A-B).</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Count&nbsp;&nbsp;&nbsp;&nbsp; Size</span>

	<span style="font-family: courier new,courier">&nbsp; A&nbsp;&nbsp;&nbsp; 204310 17394824</span>

	<span style="font-family: courier new,courier">&nbsp; B&nbsp;&nbsp;&nbsp; 204296 17393604</span>

	<span style="font-family: courier new,courier">&nbsp; A-B&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 14&nbsp;&nbsp;&nbsp;&nbsp; 1220&nbsp; =&nbsp;&nbsp; 0.00701 % of B</span>

	

	<span style="font-family: courier new,courier">Differences by kind, largest absolute size diffs first.</span>

	<span style="font-family: courier new,courier">&nbsp;Index&nbsp; Count&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp; Cumulative&nbsp; % of B Kind (class / dict of class)</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 468&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 468&nbsp;&nbsp; 0.00269 str</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 272&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 740&nbsp;&nbsp; 0.00425 dict (no owner)</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 152&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 892&nbsp;&nbsp; 0.00513 ubuntuone.syncdaemon.marker.MDMarker</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 92&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 984&nbsp;&nbsp; 0.00566 ubuntuone.syncdaemon.action_queue.Upload</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1040&nbsp;&nbsp; 0.00598 unicode</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1096&nbsp;&nbsp;&nbsp; 0.0063 ubuntuone.syncdaemon.logger.mklog</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 52&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1148&nbsp;&nbsp;&nbsp; 0.0066 ubuntuone.syncdaemon.action_queue.MakeFile</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 36&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1184&nbsp;&nbsp; 0.00681 types.MethodType</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 36&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1220&nbsp;&nbsp; 0.00701 ubuntuone.syncdaemon.sync.FSKey</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1220&nbsp;&nbsp; 0.00701 dict of ubuntuone.syncdaemon.event_queue.MyReader</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; 10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1220&nbsp;&nbsp; 0.00701 ubuntuone.syncdaemon.event_queue.MyReader</span>

</blockquote>
Seguí haciendo unos experimentos, y llegó un punto en que ciertos elementos no deberían estar más en memoria, pero estaban. Lo más piola es que pude ver <em>dónde</em>:

<blockquote>
	<span style="font-family: courier new,courier">>>> markers = h5[39]</span>

	<span style="font-family: courier new,courier">>>> markers</span>

	<span style="font-family: courier new,courier">Partition of a set of 241 objects. Total size = 18316 bytes.</span>

	<span style="font-family: courier new,courier">&nbsp;Index&nbsp; Count&nbsp;&nbsp; %&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp;&nbsp; % Cumulative&nbsp; % Kind (class / dict of class)</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; 241 100&nbsp;&nbsp;&nbsp; 18316 100&nbsp;&nbsp;&nbsp;&nbsp; 18316 100 ubuntuone.syncdaemon.marker.MDMarker</span>

	<span style="font-family: courier new,courier">>>> markers.referrers</span>

	<span style="font-family: courier new,courier">Partition of a set of 2 objects. Total size = 6332 bytes.</span>

	<span style="font-family: courier new,courier">&nbsp;Index&nbsp; Count&nbsp;&nbsp; %&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp;&nbsp; % Cumulative&nbsp; % Kind (class / dict of class)</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp; 50&nbsp;&nbsp;&nbsp;&nbsp; 6280&nbsp; 99&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6280&nbsp; 99 dict (no owner)</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp; 50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 52&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6332 100 collections.deque</span>

	<span style="font-family: courier new,courier">>>> markers.referrers[0].referrers</span>

	<span style="font-family: courier new,courier">Partition of a set of 1 object. Total size = 136 bytes.</span>

	<span style="font-family: courier new,courier">&nbsp;Index&nbsp; Count&nbsp;&nbsp; %&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp;&nbsp; % Cumulative&nbsp; % Kind (class / dict of class)</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 136 100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 136 100 dict of ubuntuone.syncdaemon.action_queue.DeferredMap</span>

	<span style="font-family: courier new,courier">>>> markers.referrers[1].referrers</span>

	<span style="font-family: courier new,courier">Partition of a set of 1 object. Total size = 520 bytes.</span>

	<span style="font-family: courier new,courier">&nbsp;Index&nbsp; Count&nbsp;&nbsp; %&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp;&nbsp; % Cumulative&nbsp; % Kind (class / dict of class)</span>

	<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 520 100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 520 100 dict of ubuntuone.syncdaemon.file_shelf.LRUCache</span>

</blockquote>
El segundo es un caché, y está todo bien, está acotado y cuando se suelte, se volarán. Pero el primer es un leak (del código nuestro, no de Python), y me confirmó lo que yo había visto por inspección del código.



Buenísimo el Heapy, :D |
