.. title: Toqueteando el teclado
.. date: 2023-05-10 11:30:00
.. tags: teclado, configuraci√≥n, Unicode, Linux, eventos


El teclado es una de las mejores interfaces que tenemos con la computadora. Nos acompa√±a desde hace mucho m√°s de medio siglo y fue cambiando mucho con el tiempo. Hoy en d√≠a mismo hay muchas variaciones, pero en general apenas pensamos en su complejidad: los enchufamos, apretamos las teclas y esperamos que las letras aparezcan en la pantalla.

*Disclaimer 1: mucho de lo que diga en los pr√≥ximos p√°rrafos, pero no todo, depender√° de qu√© distribuci√≥n de teclado tengas y c√≥mo est√© configurado, ya voy a ir marcando esos detalles.*

Tambi√©n estamos acostumbrades a que hayan teclas con distintas funcionalidades. Las "letras" son directas (las apretamos y algo aparece), pero otras son modificadoras (el "shift", el "alt"). Hay teclas que parecen agregadas, como las de funci√≥n que est√°n un poco m√°s arriba, o el teclado num√©rico de la derecha que incluso ni est√° en las laptops m√°s peque√±as. Hay otras m√°s raras incluso, como el "Break" o "Sys Rq" que tampoco usamos demasiado (o nada).

.. image:: /images/teclado.png
    :alt: El teclado que uso en el escritorio

Pero, ¬øcu√°l es el "recorrido" entre que apretamos una tecla y aparece una letra en nuestro editor de textos? Esto es lo que les voy a contar un poco por arriba, ya que tuve que aprenderlo para configurar mi teclado como yo quer√≠a. No es la idea entender toda la complejidad del sistema de entrada del teclado, pero s√≠ lo necesario para poder configurarlo un poco.


Entendiendo las relaciones
--------------------------

Mi objetivo era poder meter caracteres de forma simple cuando estaba escribiendo. Claro, si quiero la "j" aprieto la ``j``, si quiero la "L" aprieto ``SHIFT+l``, si quiero una "√©" aprieto ``ALTGR+e``, o incluso si necesito un "¬º" aprieto ``ALTGR+SHIFT+6``. ¬øPero qu√© pasa si quiero un "‚àû" o un "üî•"? ¬°No *est√°n*! ¬øC√≥mo las *agrego*?

*Disclaimer 2: se pone m√°s espesa la cosa ac√°; lo siguiente est√° basado en mi sistema operativo y entorno de escritorio (Kubuntu 22.04, con KDE Plasma 5.24, sobre X11); aunque creo que todos los sistemas "m√°s o menos modernos" van a ser iguales o muy parecidos. Puede fallar.*

En los ubuntus la parte de manejo del teclado bajo X11 est√° en ``/usr/share/X11/xkb/``. Los s√≠mbolos que va a tirar cada tecla est√°n bajo ese directorio en ``/symbols/`` en un archivo que depender√° de tu distribuci√≥n de teclado. 

Yo tengo un teclado ingl√©s internacional, as√≠ que el archivo que me interesa es el ``/usr/share/X11/xkb/symbols/us``. Ah√≠ dentro no todo es tan directo, ya que puede estar configurado de varias maneras, en distintas "variantes". Como les dec√≠a antes, yo uso ``English (intl., with AltGr dead keys)``, que en el archivo lleva el c√≥digo ``altgr-intl``. En esa secci√≥n encuentro la definici√≥n de cada tecla, como...

::

   key <AC07> { [        j, J,           idiaeresis,   Idiaeresis      ] };
   key <AB02> { [        x, X,           oe,           OE              ] };

...pero no todas, ya que aqu√≠ est√°n solo las diferencias contra el mapa "base" (en realidad es una estructura de herencia en √°rbol); en este caso dice ``include "us(intl)"``, lo que indica que es el archivo ``us`` (el que ya estamos viendo), el mapa ``intl``, y as√≠ siguiendo.

Entonces, cada l√≠nea de esas nos da una tecla. Entre los corchetes podemos tener dos o cuatro elementos. Los primeros/√∫nicos dos indica qu√© car√°cter aparece cuando apretamos la tecla y cuando la apretamos con Shift, y si tenemos tercer y cuarto elemento es AltGr+tecla y Shift+AltGr+tecla. Para el primer caso del ejemplo mostrado, ser√≠a entonces::

    TECLA:              j
    SHIFT+TECLA:        J
    ALTGR+TECLA:        √Ø
    SHIFT+ALTGR+TECLA:  √è

Vemos que a veces no se usan los caracteres en s√≠ sino sus nombres; la conversi√≥n est√° definida en este archivo de las fuentes de X11: ``/usr/include/X11/keysymdef.h``. Tambi√©n se puede usar el c√≥digo Unicode directamente, arrancando con U (ej: ``U13BF``).

Par√©ntesis. "AltGr" viene de /alternate graphic/, "alternativa gr√°fica". Cierro par√©ntesis.

.. image:: /images/layout-teclado.png
    :alt: Mi layout; azul para AltGr (verde si es compuesta)


Sigamos. 

En el ejemplo que vimos es obvio que la tecla en cuesti√≥n es "la de la jota", ¬øpero qu√© es ese c√≥digo ``AC07`` con que se define? Si arranca con ``A`` la segunda letra es la fila de teclas "comunes" de la parte principal de teclado, arrancando con ``A`` la primera fila de abajo, y la posici√≥n de la tecla arrancando de 1 a la izquierda. Entonces para nuestro teclado la ``AC`` es la tercer fila, la que arranca con la tecla ``a`` y si contamos para la derecha, la s√©ptima ``AC07`` es la ``j``. Otros prefijos indican otras zonas: ``FK`` son las teclas de funci√≥n, ``KP`` las del teclado num√©rico, y as√≠. Y tambi√©n hay teclas con nombre espec√≠fico: ``TAB``, ``CAPS``, ``RTRN``, etc.

M√°s par√©ntesis. Si miramos nuestro teclado vemos que la primera fila (la de abajo de todo, la de la barra espaciadora) no tiene "teclas comunes", entonces ``AA`` no tendr√≠a sentido... pero hay todo tipo de teclados, `este por ejemplo <https://wiki.laptop.org/go/OLPC_English_Non-membrane_Keyboard>`_ nos muestra un caso con signos en esa fila. Hay de todo en este mundo. Nuevamente cierro par√©ntesis.

¬øPero c√≥mo sabe el sistema que cuando apretamos f√≠sicamente una tecla de nuestro teclado esa es la quinta de la tercer fila? Ah√≠ ya depende del tipo de teclado y c√≥mo se lee su entrada. Podemos preguntarlo::

    $ setxkbmap -query
    rules:      evdev
    model:      pc104
    layout:     us
    variant:    altgr-intl

All√≠ tenemos el layout con variante y todo (que ya mencion√© arriba para llegar a la configuraci√≥n del teclado), pero lo que quiero destacar es el ``rules``, que en mi caso (y en la mayor√≠a de los Linux modernos) es `evdev <https://es.wikipedia.org/wiki/Evdev>`_, una interfaz de entrada que traduce los eventos de los drivers de los dispositivos y los pone a disposici√≥n de las capas superiores al kernel, como X.

Podemos leer f√°cilmente la entrada de estos eventos. Jugando, yo me hice un `programita que muestra los c√≥digos de cada tecla <http://linkode.org/#tKdUEHQn47jmvuMv4AvC42>`_. Y luego encontr√© que hay una peque√±a utilidad que tambi√©n lo hace: ``showkey``.

Si corremos cualquiera de los dos nos va a dar que "la tecla de la J" genera el c√≥digo 36. Esto lo traducimos usando el archivo ``/usr/share/X11/xkb/keycodes/evdev`` donde vemos la correspondencia entre ``AC07`` (el c√≥digo para la l√≠nea de la ``J`` que vimos arriba) y el 44, que es 36 (que obtuvimos del teclado) m√°s 8 (que es el m√≠nimo que declara ese mismo archivo)::

    default xkb_keycodes "evdev" {
    	minimum = 8;
    	maximum = 255;
    (...)
    	<AC07> = 44;
    

Agregando un car√°cter
---------------------

Hagamos ahora el recorrido √∫til, motivado por el deseo de tener una combinaci√≥n de teclas que me escriba el s√≠mbolo del infinito.

La idea ser√≠a ponerlo en una tecla que no tenga car√°cter especial (para no pisar alguno potencialmente √∫til). Me decid√≠ por SHIFT+ALTGR+M, que por default tiene al mismo *mu* que ALTGR+M.

Con el ``showkey`` veo que la tecla es la 50, y usando el archivo ``keycodes/evdev`` veo que 58 corresponde a ``AB07``, lo cual tiene sentido porque la ``M`` es la s√©ptima tecla en la segunda fila de mi teclado.

Yendo al ``symbols/us`` veo que la variante ``altgr-intl`` no define ``AB07``. Vamos a su "ancestro", ``intl``, y all√≠ la encontramos::

    key <AB07> { [         m,          M,            mu,               mu ] };

Reemplazo el cuarto valor por ``infinity`` (podr√≠a haber puesto ``U221E`` pero el nombre es m√°s descriptivo)::

    key <AB07> { [         m,          M,            mu,         infinity ] };

Luego, para refrescar el uso de ese mapa (sin tener que reloguearme o reiniciar la m√°quina)::

    sudo setxkbmap us -variant altgr-intl

Y listo: ``‚àû``.

Lo ideal ser√≠a poder tener el dibujo de los caracteres "extras" en el frente de cada tecla, como en mi a√±orada Commodore 128:

.. image:: /images/commodore128.jpeg
    :alt: Pasado ¬øy futuro? del dise√±o de teclas
    :target: /images/commodore128.jpeg
